<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>US to US — Humana Brasil</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.umd.js"></script>
  <style>
    :root{--green:#1E7E34;--ink:#1b1b1b;--bg:#fafafa;--muted:#667085}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:900px;margin:0 auto;padding:20px}
    header{text-align:center;padding:20px 0}
    h1{margin:0 0 6px;font-size:26px}
    .lead{color:var(--muted);margin:0 0 12px}
    form{background:#fff;border:1px solid #eee;border-radius:12px;padding:22px;box-shadow:0 2px 8px rgba(0,0,0,.04)}
    .form-grid{display:grid;grid-template-columns:1fr;gap:16px}
    label{display:block;font-weight:600;margin:8px 0 6px}
    input,textarea{width:100%;border:1px solid #d8dee4;border-radius:8px;padding:12px;font:inherit}
    textarea{min-height:130px;resize:vertical}
    .file-info{background:#f0f7f4;border-left:4px solid var(--green);padding:10px;border-radius:6px;margin-top:8px;font-size:13px;display:none}
    .btn{background:var(--green);color:#fff;border:0;border-radius:10px;padding:10px 16px;font-weight:600;cursor:pointer;font-size:14px}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .inline-actions{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:6px}
    .muted{color:var(--muted);font-size:12px}
    .status{min-height:22px;color:var(--muted);margin:12px 0 0;font-size:14px}
    .status.error{color:#d32f2f}
    .status.success{color:#1E7E34}
    .debug{background:#f5f5f5;border:1px solid #ddd;border-radius:8px;padding:12px;margin:12px 0;font-size:12px;font-family:monospace;max-height:240px;overflow:auto;display:none;white-space:pre-wrap}
  </style>
</head>
<body>
  <header class="wrap">
    <h1>US to US</h1>
    <p class="lead">Gere um documento a partir da Ficha de Identificação, Edital e campos abaixo</p>
  </header>

  <main class="wrap">
    <form id="usForm" class="form-grid" novalidate>
      <div>
        <label>Ficha de Identificação (PDF ou DOCX) *</label>
        <input type="file" id="fichaFile" accept=".pdf,.docx,.doc,.txt" required>
        <div id="fichaInfo" class="file-info"></div>
      </div>

      <div>
        <label>Edital (PDF ou DOCX) *</label>
        <input type="file" id="editalFile" accept=".pdf,.docx,.doc,.txt" required>
        <div id="editalInfo" class="file-info"></div>
      </div>

      <div>
        <label>Contexto *</label>
        <textarea id="contexto" placeholder="Explique o contexto, problemas a endereçar, experiências relevantes..." required></textarea>
        <div class="inline-actions">
          <button type="button" class="btn" id="aiContexto">Sugerir com IA</button>
          <span class="muted" id="aiContextoHint"></span>
        </div>
      </div>

      <div>
        <label>O que queremos fazer? *</label>
        <textarea id="oque" placeholder="Descreva a proposta de atuação, etapas, público, resultados..." required></textarea>
        <div class="inline-actions">
          <button type="button" class="btn" id="aiOque">Sugerir com IA</button>
          <span class="muted" id="aiOqueHint"></span>
        </div>
      </div>

      <button id="submitBtn" class="btn" type="submit">Gerar US to US (DOCX)</button>
      <p id="status" class="status"></p>
      <div id="debug" class="debug"></div>
    </form>
  </main>

  <script>
    const WEBHOOK_URL = 'https://hook.us2.make.com/7whb778vlmgg9yst3o5ua2cq4g4dh654'; // fluxo principal
    const AUTOCOMPLETE_WEBHOOK_URL = 'https://hook.us2.make.com/w6gspd8kkiuai5v3aqe5dzb3c5xvcwvr'; // <-- SUBSTITUA

    const $ = (s)=>document.querySelector(s);
    const sanitize = (s)=> (s==null?'':String(s).replace(/\uFEFF/g,'').replace(/[\u0000-\u001F\u007F-\u009F]/g,'').replace(/\r?\n/g,' ').replace(/\s+/g,' ').trim());
    const statusEl = $('#status'), debugEl = $('#debug');

    async function readPDF(file){
      const arr = await file.arrayBuffer();
      pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
      const pdf = await pdfjsLib.getDocument({data:arr}).promise;
      let text=''; for(let p=1;p<=pdf.numPages;p++){ const pg=await pdf.getPage(p); const tc=await pg.getTextContent(); text += tc.items.map(i=>i.str).join(' ')+' '; }
      return sanitize(text);
    }
    async function readDOCX(file){
      const arr = await file.arrayBuffer();
      const res = await mammoth.extractRawText({arrayBuffer:arr});
      return sanitize(res.value);
    }
    async function readAny(file){
      const name = (file.name||'').toLowerCase();
      if(name.endsWith('.pdf')) return readPDF(file);
      if(name.endsWith('.docx')||name.endsWith('.doc')) return readDOCX(file);
      return sanitize(await file.text());
    }

    // --- Parsers robustos ---
    function stripFences(s){
      if(!s) return '';
      let t = String(s).trim();
      if(t.startsWith('```')) t = t.replace(/^```(?:json)?\s*/i,'');
      if(t.endsWith('```')) t = t.slice(0,-3);
      return t.trim();
    }

    // Extrai texto do "envelope" do Anthropic, se o Make devolveu o objeto inteiro
    function anthroTextFromEnvelope(raw){
      try{
        const obj = JSON.parse(raw);
        if(obj && Array.isArray(obj.content)){
          return obj.content.map(c=>c?.text||'').join('');
        }
      }catch(_){}
      return null;
    }

    // Parser de sugestão que aceita:
    // 1) JSON puro {"suggest":{...}}
    // 2) Envelope Anthropic -> content[].text -> JSON lá dentro
    // 3) Texto cru (usa como sugestão direta)
    function parseSuggest(raw){
      if(!raw) return null;
      let t = stripFences(raw);

      // 2) se veio envelope Anthropic
      const env = anthroTextFromEnvelope(t);
      if(env!=null) t = env;

      // tenta JSON direto
      try{
        const j = JSON.parse(t);
        if(j?.suggest?.text) return j;
      }catch(_){}

      // tenta achar início do {"suggest"
      const k = t.indexOf('{"suggest"');
      if(k>=0){
        try{
          const sliced = t.slice(k);
          const j2 = JSON.parse(sliced);
          if(j2?.suggest?.text) return j2;
        }catch(_){}
      }

      // se não for JSON, usa como texto direto
      const txt = sanitize(t);
      if(txt) return {suggest:{field:"", text:txt}};
      return null;
    }

    // --- Autocomplete com IA ---
    async function aiSuggest(field){
      const hint = field==='contexto' ? $('#aiContextoHint') : $('#aiOqueHint');
      try{
        if(!AUTOCOMPLETE_WEBHOOK_URL || AUTOCOMPLETE_WEBHOOK_URL.includes('SEU_WEBHOOK_AUTOCOMPLETE')){
          hint.textContent = 'Configurar webhook do autocomplete.';
          return;
        }
        const fichaFile = $('#fichaFile').files[0];
        const editalFile = $('#editalFile').files[0];
        hint.textContent = 'Gerando sugestão...';

        const fichaTxt = fichaFile ? await readAny(fichaFile) : '';
        const editalTxt = editalFile ? await readAny(editalFile) : '';

        const payload = { ficha: fichaTxt.slice(0,60000), edital: editalTxt.slice(0,60000), field, max_words: 180 };
        const resp = await fetch(AUTOCOMPLETE_WEBHOOK_URL, {
          method:'POST', headers:{'Content-Type':'application/json','Accept':'application/json, text/plain'},
          body: JSON.stringify(payload)
        });
        const text = await resp.text();
        if(!resp.ok) throw new Error(`HTTP ${resp.status} ${resp.statusText} | ${text.slice(0,500)}`);

        const data = parseSuggest(text);
        const out = sanitize(data?.suggest?.text || '');
        if(!out){
          hint.textContent = 'Sugestão indisponível.';
          debugEl.textContent = 'Resposta do autocomplete não reconhecida:\n'+ text.slice(0,1000);
          debugEl.style.display='block';
          return;
        }
        if(field==='contexto'){ const el=$('#contexto'); el.value = out; }
        else { const el=$('#oque'); el.value = out; }
        hint.textContent = 'Sugestão aplicada. Edite à vontade.';
      }catch(err){
        hint.textContent = 'Sugestão indisponível.';
        debugEl.textContent = String(err);
        debugEl.style.display='block';
      }
    }

    // ====== (restante do seu código de geração de DOCX permanece igual) ======
    // Dica: mantenha aqui as funções/métodos de normalização e geração de DOCX que você já tem funcionando.

    // Liga os botões
    $('#aiContexto').addEventListener('click', ()=> aiSuggest('contexto'));
    $('#aiOque').addEventListener('click', ()=> aiSuggest('oque'));

    // Upload UI (mesmo comportamento de antes)
    const fichaFile = $('#fichaFile'), editalFile = $('#editalFile');
    const fichaInfo = $('#fichaInfo'), editalInfo = $('#editalInfo');
    fichaFile.addEventListener('change', async ()=>{
      fichaInfo.style.display='none';
      if(!fichaFile.files[0]) return;
      fichaInfo.textContent='Lendo arquivo...'; fichaInfo.style.display='block';
      try{ const txt=await readAny(fichaFile.files[0]); fichaInfo.textContent=`✓ ${fichaFile.files[0].name} carregado (${(txt.length/1024).toFixed(1)} KB texto)`; }
      catch{ fichaInfo.textContent='Erro ao ler o arquivo'; }
    });
    editalFile.addEventListener('change', async ()=>{
      editalInfo.style.display='none';
      if(!editalFile.files[0]) return;
      editalInfo.textContent='Lendo arquivo...'; editalInfo.style.display='block';
      try{ const txt=await readAny(editalFile.files[0]); editalInfo.textContent=`✓ ${editalFile.files[0].name} carregado (${(txt.length/1024).toFixed(1)} KB texto)`; }
      catch{ editalInfo.textContent='Erro ao ler o arquivo'; }
    });
  </script>
</body>
</html>

