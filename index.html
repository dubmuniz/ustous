<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>US to US — Humana Brasil</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.umd.js"></script>
  <style>
    :root{--green:#1E7E34;--ink:#1b1b1b;--bg:#fafafa;--muted:#667085}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:900px;margin:0 auto;padding:20px}
    header{text-align:center;padding:20px 0}
    h1{margin:0 0 6px;font-size:26px}
    .lead{color:var(--muted);margin:0 0 12px}
    form{background:#fff;border:1px solid #eee;border-radius:12px;padding:22px;box-shadow:0 2px 8px rgba(0,0,0,.04)}
    .form-grid{display:grid;grid-template-columns:1fr;gap:16px}
    label{display:block;font-weight:600;margin:8px 0 6px}
    input,textarea{width:100%;border:1px solid #d8dee4;border-radius:8px;padding:12px;font:inherit}
    textarea{min-height:130px;resize:vertical}
    .file-info{background:#f0f7f4;border-left:4px solid var(--green);padding:10px;border-radius:6px;margin-top:8px;font-size:13px;display:none}
    .btn{background:var(--green);color:#fff;border:0;border-radius:10px;padding:10px 16px;font-weight:600;cursor:pointer;font-size:14px}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .inline-actions{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:6px}
    .muted{color:var(--muted);font-size:12px}
    .status{min-height:22px;color:var(--muted);margin:12px 0 0;font-size:14px}
    .status.error{color:#d32f2f}
    .status.success{color:#1E7E34}
    .debug{background:#f5f5f5;border:1px solid #ddd;border-radius:8px;padding:12px;margin:12px 0;font-size:12px;font-family:monospace;max-height:260px;overflow:auto;white-space:pre-wrap}
    .hidden{display:none}
  </style>
</head>
<body>
  <header class="wrap">
    <h1>US to US</h1>
    <p class="lead">Gere um documento a partir da Ficha de Identificação, Edital e campos abaixo</p>
  </header>

  <main class="wrap">
    <form id="usForm" class="form-grid" novalidate>
      <div>
        <label>Ficha de Identificação (PDF, DOCX, TXT, XLSX, XLS) *</label>
        <input type="file" id="fichaFile" accept=".pdf,.docx,.doc,.txt,.xlsx,.xls" required>
        <div id="fichaInfo" class="file-info"></div>
      </div>

      <div>
        <label>Edital (PDF, DOCX ou TXT) *</label>
        <input type="file" id="editalFile" accept=".pdf,.docx,.doc,.txt" required>
        <div id="editalInfo" class="file-info"></div>
      </div>

      <div>
        <label>Pista de Localização (opcional, melhora a pesquisa)</label>
        <input id="localHint" type="text" placeholder="Ex: Campo Grande RJ, Niterói RJ, Piabanha RJ">
      </div>

      <div>
        <label>Contexto *</label>
        <textarea id="contexto" placeholder="Explique o contexto..." required></textarea>
        <div class="inline-actions">
          <button type="button" class="btn" id="aiContexto">Sugerir com IA</button>
          <span class="muted" id="aiContextoHint"></span>
        </div>
      </div>

      <div>
        <label>O que queremos fazer? *</label>
        <textarea id="oque" placeholder="Descreva a proposta..." required></textarea>
        <div class="inline-actions">
          <button type="button" class="btn" id="aiOque">Sugerir com IA</button>
          <span class="muted" id="aiOqueHint"></span>
        </div>
      </div>

      <button id="submitBtn" class="btn" type="submit">Gerar US to US (DOCX)</button>
      <p id="status" class="status"></p>
      <div id="debug" class="debug hidden"></div>
    </form>
  </main>

  <script>
    // ===== CONFIG =====
    const WEBHOOK_URL = 'https://hook.us2.make.com/7whb778vlmgg9yst3o5ua2cq4g4dh654';               // gera DOCX
    const AUTOCOMPLETE_WEBHOOK_URL = 'https://hook.us2.make.com/w6gspd8kkiuai5v3aqe5dzb3c5xvcwvr';    // autocomplete

    // ===== HELPERS =====
    const $ = s => document.querySelector(s);
    const show = el => el.classList.remove('hidden');
    const hide = el => el.classList.add('hidden');
    const sanitize = s => (s==null?'':String(s)
      .replace(/\uFEFF/g,'')
      .replace(/[\u0000-\u001F\u007F-\u009F]/g,'')
      .replace(/\r?\n/g,' ')
      .replace(/\s+/g,' ')
      .trim());

    async function safeFetch(url, opts={}){
      const ctrl = new AbortController();
      const to = setTimeout(()=>ctrl.abort(), 20000);
      try{
        const resp = await fetch(url, {...opts, signal: ctrl.signal});
        const text = await resp.text();
        return { ok: resp.ok, status: resp.status, statusText: resp.statusText, headers: resp.headers, text };
      } finally { clearTimeout(to); }
    }

    // ===== FILE READERS =====
    async function readPDF(file){
      const arr = await file.arrayBuffer();
      pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
      const pdf = await pdfjsLib.getDocument({data:arr}).promise;
      let text=''; 
      for(let p=1;p<=pdf.numPages;p++){
        const pg=await pdf.getPage(p);
        const tc=await pg.getTextContent();
        text += tc.items.map(i=>i.str).join(' ')+' ';
      }
      return sanitize(text);
    }
    async function readDOCX(file){
      const arr = await file.arrayBuffer();
      const res = await mammoth.extractRawText({arrayBuffer:arr});
      return sanitize(res.value);
    }
    async function readXLSX(file){
      const arr = await file.arrayBuffer();
      const wb = XLSX.read(arr, {type:'array'});
      let out = '';
      wb.SheetNames.forEach(name=>{
        const ws = wb.Sheets[name];
        const csv = XLSX.utils.sheet_to_csv(ws, {FS:'\t', RS:'\n'});
        out += `\n[${name}]\n` + csv + '\n';
      });
      try{
        const first = wb.Sheets[wb.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(first, {defval:'', raw:true});
        const rows = json.slice(0,200).map(row=>Object.values(row).join(' | ')).join('\n');
        out += '\n' + rows;
      }catch(_){}
      return sanitize(out).slice(0,120000);
    }
    async function readAny(file){
      const name = (file.name||'').toLowerCase();
      if(name.endsWith('.pdf')) return readPDF(file);
      if(name.endsWith('.docx')||name.endsWith('.doc')) return readDOCX(file);
      if(name.endsWith('.xlsx')||name.endsWith('.xls')) return readXLSX(file);
      return sanitize(await file.text());
    }

    // ===== LIMPEZA FORTE DO EDITAL =====
    function cleanEditalForContext(t){
      if(!t) return '';
      let s = ' ' + t + ' ';
      s = s.replace(/https?:\/\/\S+/gi,' ');
      s = s.replace(/(\.{3,}|_{3,}|-{3,})/g,' ');
      s = s.replace(/\b(frequently asked questions|faqs?|application process|apply now|grants? portal|character limits?|full application template|eligibility|budget guidelines?|terms of use|privacy policy|login|portal)\b[\s\S]{0,2000}/gi,' ');
      s = s.replace(/\b(sumário|índice|conteúdo)\b[\s\S]{0,2000}/gi,' ');
      s = s.replace(/^\s*\d+(\.\d+)*\s+[^\.]{3,80}\.{3,}\s*\d+\s*$/gim,' '); // linhas de índice com pontilhado
      s = s.replace(/[A-ZÁÂÃÀÉÊÍÓÔÕÚÇ]{4,}(?:\s+[A-ZÁÂÃÀÉÊÍÓÔÕÚÇ]{3,})+/g, m => m.toLowerCase());
      s = s.replace(/\s+/g,' ').trim();
      return s.slice(0,120000);
    }

    // ===== PALAVRAS-CHAVE E LOCAL =====
    const STOP = new Set('a ao aos as o os e de da do das dos em no na nos nas por para com um uma umas uns que como ser ter estar mais menos muito pouco já não sem sob sobre até entre desde pelos pelas se sua seu suas seus este esta isto esse essa isso aquele aquela aquilo ao longo dentro fora cada qual cujo cuja quais porque portanto entretanto contudo todavia também ainda mesmo mesma mesmos mesmas foi são eram será serão havia houver houve tendo sendo devido a partir'.split(/\s+/));
    function keywords(txt, max=20){
      const t = (txt||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
      const tokens = t.match(/[a-zA-Záàâãéêíóôõúç0-9_-]{3,}/g)||[];
      const freq = new Map();
      tokens.forEach(w=>{ if(!STOP.has(w)) freq.set(w,(freq.get(w)||0)+1); });
      return [...freq.entries()].sort((a,b)=>b[1]-a[1]).slice(0,max).map(x=>x[0]);
    }
    function guessLocalHint(ficha, edital, manual){
      if(manual && manual.trim()) return manual.trim();
      const t = (ficha+' '+edital);
      const m = t.match(/\b(Campo Grande|Niter[oó]i|Piabanha|Para[ií]ba do Sul|Paty do Alferes|Rio de Janeiro|Zona Oeste|Serra|Baixada)\b/gi);
      if(m && m.length) return m[0] + ' RJ';
      return 'Campo Grande Rio de Janeiro';
    }

    // ===== WIKIPEDIA ENRICHMENT =====
    async function wikiSummary(topic){
      const encoded = encodeURIComponent(topic.replace(/\s+/g,'_'));
      const url = `https://pt.wikipedia.org/api/rest_v1/page/summary/${encoded}`;
      try{
        const {ok, text} = await safeFetch(url);
        if(!ok) return '';
        const j = JSON.parse(text);
        return sanitize(j.extract || '');
      }catch{ return ''; }
    }

    // ===== PROMPT BUILDER (VARIAÇÃO REAL POR ESTILO) =====
    function buildPrompt(field, ficha, editalClean, webCtx, seed){
      const fichaKw = keywords(ficha, 12).join(', ');
      const editalKw = keywords(editalClean, 12).join(', ');
      const s = typeof seed==='number'? seed : Date.now();
      const style = s % 4; // 0..3

      const styleGuide = [
        'Estilo 0: diagnóstico, em seguida detalhe, depois implicação prática. Frases médias, coesão sem jargão.',
        'Estilo 1: pequena vinheta situacional, depois dados qualitativos, por fim síntese operacional.',
        'Estilo 2: problema, método, resultado esperado, riscos e salvaguardas.',
        'Estilo 3: mapa de atores, tensões e contramedidas, com fecho propositivo.'
      ][style];

      const base =
`SOMENTE pt-BR. Não copie frases do edital. Não use links, FAQ, termos de inscrição. Varie sintaxe e ritmo. ${styleGuide}

FICHA:
${ficha}

EDITAL_LIMPO:
${editalClean}

WEB_CONTEXT (apenas inspiração, reescreva sempre):
${webCtx}

Palavras-guia Ficha: ${fichaKw}
Palavras-guia Edital: ${editalKw}

SEED: ${s}`;

      const contexto =
`Tarefa: gerar "Contexto" com 180–260 palavras. Incluir 3 a 5 fatos locais plausíveis derivados do WEB_CONTEXT
ex: características demográficas amplas, infraestrutura, questões socioambientais, mobilidade, serviços.
Nunca mencionar Wikipedia. Não usar listas. Tom técnico direto, coeso e não repetitivo.

Saída OBRIGATÓRIA, JSON em uma linha:
{"suggest":{"field":"contexto","text":"TEXTO FINAL"}}`;

      const oque =
`Tarefa: gerar "O que queremos fazer" com 150–200 palavras. Derivar objetivos, público-alvo, atividades, método,
entregas e indicadores plausíveis a partir da FICHA e coerentes com o EDITAL_LIMPO. Trazer 3–5 entregas e uma lógica
de trabalho do tipo descoberta → prototipagem → implementação → síntese. Não repetir frases do Contexto.

Saída OBRIGATÓRIA, JSON em uma linha:
{"suggest":{"field":"oque","text":"TEXTO FINAL"}}`;

      return base + '\n\n' + (field==='contexto' ? contexto : oque);
    }

    // ===== PARSE SUGGEST =====
    function stripFences(s){
      if(!s) return '';
      let t = String(s).trim();
      if(t.startsWith('```')) t = t.replace(/^```(?:json)?\s*/i,'');
      if(t.endsWith('```')) t = t.slice(0,-3);
      return t.trim();
    }
    function parseSuggest(raw, field){
      if(!raw) return null;
      let t = String(raw).trim();
      if(!t || t.toLowerCase() === 'accepted') return null;
      t = stripFences(t);
      try{ const j = JSON.parse(t); if(j?.suggest) return j; }catch(_){}
      const k = t.indexOf('{"suggest"'); if(k>=0){ try{ const j2=JSON.parse(t.slice(k)); if(j2?.suggest) return j2; }catch(_){} }
      t = sanitize(t); if(t && t.length>40) return {suggest:{field, text:t}};
      return null;
    }

    // ===== AUTOCOMPLETE (TUDO NO FRONT) =====
    async function aiSuggest(field){
      const hint = field==='contexto' ? $('#aiContextoHint') : $('#aiOqueHint');
      hide($('#debug'));
      try{
        hint.textContent='Lendo arquivos...';
        const f = $('#fichaFile').files[0];
        const e = $('#editalFile').files[0];
        const fichaTxt = f ? await readAny(f) : '';
        const editalRaw = e ? await readAny(e) : '';
        const editalTxt = cleanEditalForContext(editalRaw);
        const local = guessLocalHint(fichaTxt, editalTxt, $('#localHint').value);

        hint.textContent='Pesquisando contexto...';
        const webCtx = await wikiSummary(local);

        const seed = Date.now();
        const prompt = buildPrompt(field, fichaTxt, editalTxt, webCtx, seed);

        hint.textContent='Gerando com IA...';
        const { ok, status, statusText, headers, text } = await safeFetch(AUTOCOMPLETE_WEBHOOK_URL, {
          method:'POST',
          headers:{'Content-Type':'application/json','Accept':'application/json, text/plain'},
          body: JSON.stringify({ field, prompt }) // Make só repassa isso ao Claude
        });

        $('#debug').textContent = `AUTOCOMPLETE status: ${status} ${statusText}
content-type: ${headers.get('content-type')||''}
RAW:
${text.slice(0,1000)}`;
        show($('#debug'));

        let out;
        if(!ok || String(text).trim().toLowerCase()==='accepted'){
          out = 'Sugestão indisponível. Ajuste o Webhook response no Make.';
        }else{
          const data = parseSuggest(text, field) || { suggest:{ field, text:'' } };
          out = sanitize(data.suggest.text || '');
          if(!out || out.length<60) out = 'Texto insuficiente. Tente novamente.';
        }

        if(field==='contexto') $('#contexto').value = out; else $('#oque').value = out;
        hint.textContent = 'Sugestão aplicada.';
      }catch(err){
        const target = field==='contexto' ? $('#aiContextoHint') : $('#aiOqueHint');
        target.textContent = 'Sugestão indisponível';
        $('#debug').textContent = String(err);
        show($('#debug'));
        console.error(err);
      }
    }

    // ===== DOCX =====
    const H = docx.HeadingLevel;
    const P = (t,opts={})=> new docx.Paragraph({text:t||'',...opts});
    const H1 = (t)=> P(t,{heading:H.HEADING_1});
    const H2 = (t)=> P(t,{heading:H.HEADING_2});
    function makeDocx(data){
      const d = data.us_to_us;
      return new docx.Document({
        sections:[{properties:{},children:[
          H1(`De Nós para Nós — ${d.partner||'Parceiro'}`), P(''),
          H2('Parceiro'), P(d.partner||''),
          H2('Tamanho da Subvenção'), P(d.grant_size||''),
          H2('Prazo de Execução'), P(d.timeframe||''),
          H2('Prazo de Submissão'), P(d.deadline||''), P(''),
          H2('1. Contexto'), P(d.background||''),
          H2('2. Resumo do Edital / Oportunidade'), P(d.summary_call||''),
          H2('3. O que o Parceiro Busca'), P(d.partner_wants||''),
          H2('4. Descrição Geral do que Queremos Fazer'), P(d.general_description||''),
          H2('Faixa Etária e Gênero'), P(d.age_gender||''),
          H2('Como Faremos as Formações?'), P(d.training_how||''),
          H2('5. Atividades Principais'), ...(d.main_activities||[]).map(x=>P('• '+x)),
          H2('6. O que as Pessoas Farão'), P(d.people_should_do||''),
          H2('7. Como Organizaremos a Unidade Produtiva (inclui organograma)'), P(d.organize_productive_unit||''),
          H2('8. Como Organizaremos as Pessoas no Projeto (inclui ilustração)'), P(d.organize_people||''),
          H2('10. Orçamento (linhas principais, contrapartidas e soluções)'), P(d.economy||''),
          H2('11. Instruções Técnicas (opcional)'), P(d.technical_instructions||'')
        ]}]
      });
    }
    async function saveDocx(doc, filename){
      const blob = await docx.Packer.toBlob(doc);
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download = filename || ('US_to_US_'+Date.now()+'.docx');
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    // ===== EVENTOS =====
    document.getElementById('aiContexto').addEventListener('click', ()=> aiSuggest('contexto'));
    document.getElementById('aiOque').addEventListener('click', ()=> aiSuggest('oque'));

    document.getElementById('fichaFile').addEventListener('change', async ()=>{
      const el = $('#fichaInfo'); el.style.display='none';
      if(!$('#fichaFile').files[0]) return;
      el.textContent='Lendo arquivo...'; el.style.display='block';
      try{ const txt=await readAny($('#fichaFile').files[0]); el.textContent=`✓ ${$('#fichaFile').files[0].name} carregado (${(txt.length/1024).toFixed(1)} KB texto)`; }
      catch{ el.textContent='Erro ao ler o arquivo'; }
    });
    document.getElementById('editalFile').addEventListener('change', async ()=>{
      const el = $('#editalInfo'); el.style.display='none';
      if(!$('#editalFile').files[0]) return;
      el.textContent='Lendo arquivo...'; el.style.display='block';
      try{ const txt=await readAny($('#editalFile').files[0]); el.textContent=`✓ ${$('#editalFile').files[0].name} carregado (${(txt.length/1024).toFixed(1)} KB texto)`; }
      catch{ el.textContent='Erro ao ler o arquivo'; }
    });

    // SUBMIT → webhook principal (gera DOCX via backend que você já tem)
    document.getElementById('usForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      hide($('#debug'));
      const statusEl = $('#status');
      statusEl.classList.remove('error','success');
      statusEl.textContent='';

      const ctx = sanitize($('#contexto').value);
      const oq = sanitize($('#oque').value);
      if(!$('#fichaFile').files[0] || !$('#editalFile').files[0] || !ctx || !oq){
        statusEl.textContent='Preencha todos os campos e anexe os arquivos requeridos.';
        statusEl.classList.add('error'); return;
      }

      try{
        $('#submitBtn').disabled=true; statusEl.textContent='Lendo arquivos...';
        const fichaTxt = await readAny($('#fichaFile').files[0]);
        const editalTxt = await readAny($('#editalFile').files[0]);

        const limit = (s,m)=> s.length>m ? (s.slice(0,m)+'... [truncado]') : s;
        const payload = {
          ficha: limit(fichaTxt, 120000),
          edital: limit(cleanEditalForContext(editalTxt), 120000),
          contexto: limit(ctx, 6000),
          o_que_queremos_fazer: limit(oq, 6000),
          local_hint: $('#localHint').value||''
        };

        statusEl.textContent='Enviando para processamento...';
        const { ok, status, statusText, text } = await safeFetch(WEBHOOK_URL,{
          method:'POST', headers:{'Content-Type':'application/json','Accept':'application/json, text/plain'},
          body: JSON.stringify(payload)
        });
        if(!ok) throw new Error(`HTTP ${status} ${statusText} | ${text.slice(0,600)}`);

        statusEl.textContent='Interpretando resposta...';
        let respText = text.trim();
        if(respText.toLowerCase()==='accepted') throw new Error('Webhook principal sem corpo JSON.');

        let parsed = null;
        try{ parsed = JSON.parse(respText); }
        catch{
          const idx = respText.indexOf('{"us_to_us"');
          if(idx>=0) parsed = JSON.parse(respText.slice(idx));
        }
        if(!parsed || !parsed.us_to_us) throw new Error('Resposta inválida do backend.');

        statusEl.textContent='Gerando DOCX...';
        const doc = makeDocx(parsed);
        const fname = 'US_to_US_'+(parsed.us_to_us?.meta?.filename || Date.now())+'.docx';
        await saveDocx(doc, fname);

        statusEl.textContent='✓ Documento gerado';
        statusEl.classList.add('success');
      }catch(err){
        statusEl.textContent='Erro: '+err.message;
        statusEl.classList.add('error');
        $('#debug').textContent = String(err);
        show($('#debug'));
        console.error(err);
      }finally{
        $('#submitBtn').disabled=false;
      }
    });
  </script>
</body>
</html>






