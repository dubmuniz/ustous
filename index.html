<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>US to US — Humana Brasil</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.umd.js"></script>
  <style>
    :root{--green:#1E7E34;--ink:#1b1b1b;--bg:#fafafa;--muted:#667085}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:900px;margin:0 auto;padding:20px}
    header{text-align:center;padding:20px 0}
    h1{margin:0 0 6px;font-size:26px}
    .lead{color:var(--muted);margin:0 0 12px}
    form{background:#fff;border:1px solid #eee;border-radius:12px;padding:22px;box-shadow:0 2px 8px rgba(0,0,0,.04)}
    .form-grid{display:grid;grid-template-columns:1fr;gap:16px}
    label{display:block;font-weight:600;margin:8px 0 6px}
    input,textarea{width:100%;border:1px solid #d8dee4;border-radius:8px;padding:12px;font:inherit}
    textarea{min-height:130px;resize:vertical}
    .file-info{background:#f0f7f4;border-left:4px solid var(--green);padding:10px;border-radius:6px;margin-top:8px;font-size:13px;display:none}
    button{background:var(--green);color:#fff;border:0;border-radius:10px;padding:12px 20px;font-weight:600;cursor:pointer;font-size:16px;width:100%}
    button:disabled{opacity:.6;cursor:not-allowed}
    .status{min-height:22px;color:var(--muted);margin:12px 0 0;font-size:14px}
    .status.error{color:#d32f2f}
    .status.success{color:#1E7E34}
    .debug{background:#f5f5f5;border:1px solid #ddd;border-radius:8px;padding:12px;margin:12px 0;font-size:12px;font-family:monospace;max-height:240px;overflow:auto;display:none;white-space:pre-wrap}
  </style>
</head>
<body>
  <header class="wrap">
    <h1>US to US</h1>
    <p class="lead">Gere um documento a partir da Ficha de Identificação, Edital e campos abaixo</p>
  </header>

  <main class="wrap">
    <form id="usForm" class="form-grid" novalidate>
      <div>
        <label>Ficha de Identificação (PDF ou DOCX) *</label>
        <input type="file" id="fichaFile" accept=".pdf,.docx,.doc,.txt" required>
        <div id="fichaInfo" class="file-info"></div>
      </div>

      <div>
        <label>Edital (PDF ou DOCX) *</label>
        <input type="file" id="editalFile" accept=".pdf,.docx,.doc,.txt" required>
        <div id="editalInfo" class="file-info"></div>
      </div>

      <div>
        <label>Contexto *</label>
        <textarea id="contexto" placeholder="Explique o contexto, problemas a endereçar, experiências relevantes..." required></textarea>
      </div>

      <div>
        <label>O que queremos fazer? *</label>
        <textarea id="oque" placeholder="Descreva a proposta de atuação, etapas, público, resultados..." required></textarea>
      </div>

      <button id="submitBtn" type="submit">Gerar US to US (DOCX)</button>
      <p id="status" class="status"></p>
      <div id="debug" class="debug"></div>
    </form>
  </main>

  <script>
    const WEBHOOK_URL = 'https://hook.us2.make.com/7whb778vlmgg9yst3o5ua2cq4g4dh654';
    const $ = (s)=>document.querySelector(s);
    const sanitize = (s)=> (s==null?'':String(s).replace(/\uFEFF/g,'').replace(/[\u0000-\u001F\u007F-\u009F]/g,'').replace(/\r?\n/g,' ').replace(/\s+/g,' ').trim());

    async function readPDF(file){
      const arr = await file.arrayBuffer();
      pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
      const pdf = await pdfjsLib.getDocument({data:arr}).promise;
      let text=''; for(let p=1;p<=pdf.numPages;p++){ const pg=await pdf.getPage(p); const tc=await pg.getTextContent(); text += tc.items.map(i=>i.str).join(' ')+' '; }
      return sanitize(text);
    }
    async function readDOCX(file){
      const arr = await file.arrayBuffer();
      const res = await mammoth.extractRawText({arrayBuffer:arr});
      return sanitize(res.value);
    }
    async function readAny(file){
      const name = (file.name||'').toLowerCase();
      if(name.endsWith('.pdf')) return readPDF(file);
      if(name.endsWith('.docx')||name.endsWith('.doc')) return readDOCX(file);
      return sanitize(await file.text());
    }

    function stripFences(s){
      if(!s) return '';
      let t = String(s).trim();
      if(t.startsWith('```')) t = t.replace(/^```(?:json)?\s*/i,'');
      if(t.endsWith('```')) t = t.slice(0,-3);
      return t.trim();
    }
    function parseClaude(raw){
      let t = stripFences(raw).replace(/\uFEFF/g,'').replace(/[\u0000-\u0008\u000B\u000C\u000E-\u001F\u007F]/g,'');
      const i = t.indexOf('{"us_to_us"'); if(i>0) t = t.slice(i);
      try{ return JSON.parse(t); }catch(e){ return null; }
    }

    // ==== Extratores simples do edital ====
    function extractPartner(edital){
      const txt = (edital||'').toLowerCase();
      const hits = [
        ...txt.matchAll(/\b(fundação oswaldo cruz|fiocruz|national geographic|banco mundial|unesco|unicef|pnud|giz|bid|bndes|ministério [a-zçãé ]+)\b/gi)
      ];
      return hits.length? capitalize(hits[0][0]) : '';
    }
    function extractGrant(edital){
      const m = (edital||'').match(/(R\$\s?[\d\.\,]+|\bUS\$?\s?[\d\.\,]+|€\s?[\d\.\,]+)\s*(mil(hões)?|k)?/i);
      return m? m[0].replace(/\s{2,}/g,' ') : '';
    }
    function extractTimeframe(edital){
      const m = (edital||'').match(/\b(\d{1,2})\s*(mes(es)?|month[s]?|m)\b/i);
      return m? `${m[1]} meses` : '12 meses';
    }
    function extractDeadline(edital){
      const m = (edital||'').match(/\b(\d{1,2}\/\d{1,2}\/\d{2,4}|\d{1,2}\s+de\s+\w+\s+de\s+\d{4})\b/i);
      return m? m[0] : '';
    }
    function summarizeCall(edital){
      const t = sanitize(edital||'').split(' ').slice(0,180).join(' ');
      return t || 'Resumo do edital com base no arquivo enviado.';
    }
    function partnerWants(edital){
      const txt = sanitize(edital||'');
      const cand = (txt.match(/(objetivo|finalidade|visa|busca|prop[oó]sito)[^\.]{40,200}\./i)||[])[0];
      if(cand) return cand;
      return 'O parceiro busca propostas com alinhamento a impacto mensurável, viabilidade técnica e orçamentária, e capacidade de execução com foco em resultados.';
    }
    function capitalize(s){
      return s? s.replace(/\b\p{L}/gu, c=>c.toUpperCase()) : s;
    }

    // ==== “Alongador” de texto (120–180 palavras) ====
    function expandText(base, extra){
      const seed = sanitize(base)||'';
      const sup = sanitize(extra)||'';
      const src = seed || sup || '';
      if(!src) return 'Texto não fornecido.';
      const words = src.split(' ');
      if(words.length >= 120) return src;
      // alonga com complementos dedutivos
      const add = [
        ' O plano considera coordenação intersetorial, participação ativa de escolas e lideranças locais, e mecanismos de transparência.',
        ' Metodologias participativas e dados abertos fortalecem aprendizagem, corresponsabilidade e replicabilidade.',
        ' A gestão de riscos inclui cronograma realista, governança clara, e rotinas de monitoramento com indicadores.',
        ' Resultados serão comunicados por meio de relatórios acessíveis, materiais didáticos e devolutivas públicas no território.'
      ];
      let out = src;
      for(const s of add){ if(out.split(' ').length<180) out += s; }
      return out;
    }

    // ==== Normalizador inteligente ====
    function normalizeUs(data, contexto, oque, edital, ficha){
      const us = (data && data.us_to_us) ? data.us_to_us : {};
      const partner = sanitize(us.partner || extractPartner(edital) || 'Parceiro');
      const grant = sanitize(us.grant_size || extractGrant(edital) || 'A definir conforme edital');
      const timeframe = sanitize(us.timeframe || extractTimeframe(edital));
      const deadline = sanitize(us.deadline || extractDeadline(edital));

      const background = expandText(us.background, contexto);
      const summary_call = expandText(us.summary_call, summarizeCall(edital));
      const partner_wants_txt = expandText(us.partner_wants, partnerWants(edital));
      const general_description = expandText(us.general_description, oque);
      const age_gender = sanitize(us.age_gender || 'Participação de estudantes do ensino fundamental e médio, com garantia de inclusão e equidade de gênero.');
      const training_how = expandText(us.training_how, 'Formações híbridas com oficinas práticas, trilhas interpretativas e projetos orientados por produtos, acompanhadas por tutoria.');

      const main_activities = Array.isArray(us.main_activities) && us.main_activities.length
        ? us.main_activities.map(sanitize)
        : [
            'Mapeamento participativo e diagnóstico rápido com escolas e comunidades',
            'Formações temáticas em ciência cidadã, biodiversidade urbana e produção audiovisual',
            'Implementação de hortas pedagógicas, sensores de microclima e protocolos de observação',
            'Produção de guia didático, exposição fotográfica e minidocumentário por estudantes'
          ];

      const people_should_do = expandText(us.people_should_do, 'Estudantes e docentes realizarão coletas de dados, registros fotográficos e relatos, aplicando protocolos simples e seguros.');
      const organize_productive_unit = expandText(us.organize_productive_unit, 'Estrutura em células por escola, com apoio técnico, calendário de entregas e logística compartilhada.');
      const organize_people = expandText(us.organize_people, 'Comitê de governança com papéis definidos, rotinas quinzenais, e comunicação via ferramenta colaborativa.');
      const economy = expandText(us.economy, 'Orçamento prioriza materiais pedagógicos, kits de sensores, formação de multiplicadores, comunicação e gestão.');
      const technical_instructions = expandText(us.technical_instructions, 'Padrões de dados abertos; consentimento informado; checklists de segurança para saídas de campo; backup em nuvem.');

      return {
        us_to_us:{
          meta:{ filename:'us_to_us', partner },
          partner, grant_size:grant, timeframe, deadline,
          background, summary_call, partner_wants:partner_wants_txt,
          general_description, age_gender, training_how,
          main_activities,
          people_should_do, organize_productive_unit, organize_people,
          economy, technical_instructions
        }
      };
    }

    // ==== DOCX ====
    const H = docx.HeadingLevel;
    const P = (t,opts={})=> new docx.Paragraph({text:t||'',...opts});
    const H1 = (t)=> P(t,{heading:H.HEADING_1});
    const H2 = (t)=> P(t,{heading:H.HEADING_2});

    function makeDocx(data){
      const d = data.us_to_us;
      return new docx.Document({
        sections:[{properties:{},children:[
          H1(`De Nós para Nós — ${d.partner||'Parceiro'}`), P(''),
          H2('Parceiro'), P(d.partner||''),
          H2('Tamanho da Subvenção'), P(d.grant_size||''),
          H2('Prazo de Execução'), P(d.timeframe||''),
          H2('Prazo de Submissão'), P(d.deadline||''), P(''),
          H2('1. Contexto'), P(d.background||''),
          H2('2. Resumo do Edital / Oportunidade'), P(d.summary_call||''),
          H2('3. O que o Parceiro Busca'), P(d.partner_wants||''),
          H2('4. Descrição Geral do que Queremos Fazer'), P(d.general_description||''),
          H2('Faixa Etária e Gênero'), P(d.age_gender||''),
          H2('Como Faremos as Formações?'), P(d.training_how||''),
          H2('5. Atividades Principais'), ...(d.main_activities||[]).map(x=>P('• '+x)),
          H2('6. O que as Pessoas Farão'), P(d.people_should_do||''),
          H2('7. Como Organizaremos a Unidade Produtiva (inclui organograma)'), P(d.organize_productive_unit||''),
          H2('8. Como Organizaremos as Pessoas no Projeto (inclui ilustração)'), P(d.organize_people||''),
          H2('10. Orçamento (linhas principais, contrapartidas e soluções)'), P(d.economy||''),
          H2('11. Instruções Técnicas (opcional)'), P(d.technical_instructions||'')
        ]}]
      });
    }

    async function saveDocx(doc, filename){
      const blob = await docx.Packer.toBlob(doc);
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download = filename || ('US_to_US_'+Date.now()+'.docx');
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    // ==== UI / submit ====
    const fichaFile = $('#fichaFile'), editalFile = $('#editalFile');
    const fichaInfo = $('#fichaInfo'), editalInfo = $('#editalInfo');
    const statusEl = $('#status'), debugEl = $('#debug'), submitBtn = $('#submitBtn');

    fichaFile.addEventListener('change', async ()=>{
      fichaInfo.style.display='none';
      if(!fichaFile.files[0]) return;
      fichaInfo.textContent='Lendo arquivo...'; fichaInfo.style.display='block';
      try{ const txt=await readAny(fichaFile.files[0]); fichaInfo.textContent=`✓ ${fichaFile.files[0].name} carregado (${(txt.length/1024).toFixed(1)} KB texto)`; }
      catch{ fichaInfo.textContent='Erro ao ler o arquivo'; }
    });
    editalFile.addEventListener('change', async ()=>{
      editalInfo.style.display='none';
      if(!editalFile.files[0]) return;
      editalInfo.textContent='Lendo arquivo...'; editalInfo.style.display='block';
      try{ const txt=await readAny(editalFile.files[0]); editalInfo.textContent=`✓ ${editalFile.files[0].name} carregado (${(txt.length/1024).toFixed(1)} KB texto)`; }
      catch{ editalInfo.textContent='Erro ao ler o arquivo'; }
    });

    document.getElementById('usForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      debugEl.style.display='none'; debugEl.textContent='';
      statusEl.classList.remove('error','success'); statusEl.textContent='';

      const ctx = sanitize($('#contexto').value);
      const oq = sanitize($('#oque').value);
      if(!fichaFile.files[0] || !editalFile.files[0] || !ctx || !oq){
        statusEl.textContent='Preencha todos os campos e anexe os arquivos requeridos.'; statusEl.classList.add('error'); return;
      }

      try{
        submitBtn.disabled=true; statusEl.textContent='Lendo arquivos...';
        const fichaTxt = await readAny(fichaFile.files[0]);
        const editalTxt = await readAny(editalFile.files[0]);

        const limit = (s,m)=> s.length>m ? (s.slice(0,m)+'... [truncado]') : s;
        const payload = {
          ficha: limit(fichaTxt, 60000),
          edital: limit(editalTxt, 60000),
          contexto: limit(ctx, 4000),
          o_que_queremos_fazer: limit(oq, 4000)
        };

        statusEl.textContent='Enviando para processamento...';
        const resp = await fetch(WEBHOOK_URL,{method:'POST',headers:{'Content-Type':'application/json','Accept':'application/json, text/plain'},body:JSON.stringify(payload)});
        const text = await resp.text();
        if(!resp.ok) throw new Error(`HTTP ${resp.status} ${resp.statusText} | ${text.slice(0,600)}`);

        statusEl.textContent='Interpretando resposta...';
        const parsed = parseClaude(text);

        // normalização INTELIGENTE: sempre preenche
        const safe = normalizeUs(parsed, payload.contexto, payload.o_que_queremos_fazer, payload.edital, payload.ficha);

        statusEl.textContent='Gerando DOCX...';
        const doc = makeDocx(safe);
        const fname = 'US_to_US_'+(safe.us_to_us?.meta?.filename || Date.now())+'.docx';
        await saveDocx(doc, fname);

        statusEl.textContent='✓ Documento gerado';
        statusEl.classList.add('success');
      }catch(err){
        statusEl.textContent='Erro: '+err.message;
        statusEl.classList.add('error');
        debugEl.textContent = (err && err.stack) ? err.stack : String(err);
        debugEl.style.display='block';
      }finally{
        submitBtn.disabled=false;
      }
    });
  </script>
</body>
</html>




